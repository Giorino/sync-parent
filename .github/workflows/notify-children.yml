name: Notify Child Repositories

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual dispatch"
        required: false
        default: "Manual sync trigger"

env:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Child repo listesi (satÄ±r baÅŸÄ±na bir repo)
  # Format: owner/repo-name
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CHILD_REPOS: |
    Giorino/sync-child

jobs:
  dispatch:
    name: Send dispatch to child repos
    runs-on: ubuntu-latest
    steps:
      - name: Trigger child repo workflows
        env:
          GH_TOKEN: ${{ secrets.CHILD_REPOS_PAT }}
        run: |
          echo "ğŸ“¡ Dispatching upstream-sync event to child repositories..."
          echo ""

          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)
          TRIGGER="${{ github.event_name }}"

          echo "$CHILD_REPOS" | while IFS= read -r repo; do
            # BoÅŸ satÄ±rlarÄ± atla
            repo=$(echo "$repo" | xargs)
            [ -z "$repo" ] && continue

            echo "â†’ Dispatching to: $repo"

            curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${repo}/dispatches" \
              -d "{
                \"event_type\": \"upstream-sync\",
                \"client_payload\": {
                  \"parent_repo\": \"${{ github.repository }}\",
                  \"commit_sha\": \"${COMMIT_SHA}\",
                  \"commit_message\": \"${COMMIT_MSG}\",
                  \"trigger\": \"${TRIGGER}\"
                }
              }" && echo "  âœ… Dispatched successfully" || echo "  âŒ Failed to dispatch"

            echo ""
          done

          echo "ğŸ Dispatch complete."
